name: Deploy to GitHub Pages
on:
  workflow_dispatch:
    inputs:
      artifact_name:
        description: 'Name of the Artifact to download'
        required: true
        type: string
        default: 'lede-bin-x86-64-2025.04.27.23.07'
      run_id:
        description: 'Run ID of the workflow that uploaded the Artifact'
        required: true
        type: string
        default: '14691847599'

jobs:
  Deploy:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
    - name: Clean Up Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
        sudo rm -rf /tmp/* /var/cache/* || true
        df -hT
        
    - name: Download OpenWrt Build Artifact
      uses: actions/download-artifact@v4  # 使用 v3 确保兼容性
      with:
        name: ${{ inputs.artifact_name }}
        github-token: ${{ secrets.GH_TOKEN }}
        #repository: tonylee2022/HB_OpenWrt  # 替换为您的实际仓库
        run-id: ${{ inputs.run_id }}
        path: ./bin

    - name: Remove Large Files After Download
      run: |
        echo "Removing large files from ./bin..."
        # 删除特定扩展名的大文件
        find ./bin -type f -name "*.img.gz" -delete
        find ./bin -type f -name "*.tar.xz" -delete
        find ./bin -type f -name "*.tar.gz" -delete
        find ./bin -type f -name "*.zip" -delete
        find ./bin -type f -name "*.bin" -delete
        find ./bin -type f -name "*.img" -delete
        # 或者删除超过一定大小的文件（例如大于100MB）
        find ./bin -type f -size +100M -delete
        echo "Files after cleanup:"
        ls -la ./bin
        df -hT       
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GH_TOKEN }}
        publish_dir: ./bin
        publish_branch: gh-pages
        destination_dir: releases/23.05
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Update OpenWrt repository files - ${{ inputs.artifact_name }}'
        exclude_assets: '*.tar.xz, *.img.gz, *.tar.gz, *.zip, *.bin, *.img'
        
    - name: Notify on Deploy Status
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          发布状态 ${{ job.status }}!
          工作流: ${{ github.workflow }}
          用户名: ${{ github.actor }}
          仓库: ${{ github.repository }}
          软件源已发布到 GitHub Pages！
