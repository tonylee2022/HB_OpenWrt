name: Deploy OpenWrt Packages to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      artifact_name:
        description: 'Artifact åç§°ï¼ˆè¦ä¸‹è½½çš„è½¯ä»¶åŒ…ï¼‰'
        required: true
        type: string
        default: 'lede23.05-bin'
      run_id:
        description: 'æ„å»º Artifact çš„å·¥ä½œæµ Run ID'
        required: true
        type: string
        default: '14701961294'
      version:
        description: 'OpenWrt å‘å¸ƒç‰ˆæœ¬å·ï¼ˆå¦‚ 23.05ï¼‰'
        required: true
        type: string
        default: '23.05'

jobs:
  deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Clean Up Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo rm -rf /tmp/* /var/cache/* || true
          df -hT

      - name: Download OpenWrt Build Artifact
        uses: actions/download-artifact@v4  # ä½¿ç”¨ v3 ç¡®ä¿å…¼å®¹æ€§
        with:
          name: ${{ inputs.artifact_name }}
          github-token: ${{ secrets.GH_TOKEN }}
          #repository: tonylee2022/HB_OpenWrt  # æ›¿æ¢ä¸ºæ‚¨çš„å®é™…ä»“åº“
          run-id: ${{ inputs.run_id }}

      - name: Prepare directory structure
        run: |
          mkdir -p ./bin/releases/${{ inputs.version }}
          mv ./temp-bin/* ./bin/releases/${{ inputs.version }}/ || true
          rm -rf ./temp-bin
          echo "å½“å‰ bin ç›®å½•ç»“æ„ï¼š"
          tree ./bin || ls -R ./bin

      - name: Generate recursive index.html
        run: |
          #!/usr/bin/env bash
          set -e
          cd ./bin
          find . -type d | while read dir; do
            cd "$dir"
            echo "ç”Ÿæˆ $dir/index.html"
            cat <<EOF > index.html
            <!DOCTYPE html>
            <html lang="zh-CN">
            <head>
              <meta charset="UTF-8">
              <title>ç›®å½• - ${PWD##*/}</title>
            </head>
            <body>
            <h1>ç›®å½• - ${PWD##*/}</h1>
            <ul>
          EOF
            for file in *; do
              if [ "$file" != "index.html" ]; then
                if [ -d "$file" ]; then
                  echo "  <li>[ç›®å½•] <a href=\"$file/index.html\">$file/</a></li>" >> index.html
                else
                  echo "  <li><a href=\"$file\">$file</a></li>" >> index.html
                fi
              fi
            done
            cat <<EOF >> index.html
          </ul>
          </body>
          </html>
          EOF
            cd - >/dev/null
          done

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3.0.1
        with:
          path: ./bin

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4.0.5

      - name: Notify Deploy Status
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸš€ OpenWrt å‘å¸ƒå®Œæˆï¼
            çŠ¶æ€: ${{ job.status }}
            ä»“åº“: ${{ github.repository }}
            ç‰ˆæœ¬: ${{ inputs.version }}
            Pages åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/releases/${{ inputs.version }}/
