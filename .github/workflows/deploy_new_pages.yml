name: Deploy OpenWrt Packages to GitHub Pages

on:
  workflow_dispatch:
    inputs:
      artifact_name:
        description: "Artifact åç§°ï¼ˆè¦ä¸‹è½½çš„è½¯ä»¶åŒ…ï¼‰"
        required: true
        type: string
        default: "lede23.05-bin"
      run_id:
        description: "æ„å»º Artifact çš„å·¥ä½œæµ Run ID"
        required: true
        type: string
        default: "14701961294"
      version:
        description: "OpenWrt å‘å¸ƒç‰ˆæœ¬å·ï¼ˆå¦‚ 23.05ï¼‰"
        required: true
        type: string
        default: "23.05"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    environment:
      name: github-pages
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Clean Up Disk Space
        run: |
          sudo rm -rf /tmp/* /var/cache/* || true
          df -hT

      - name: Download OpenWrt Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          github-token: ${{ secrets.GH_TOKEN }}
          #repository: tonylee2022/HB_OpenWrt  # æ›¿æ¢ä¸ºæ‚¨çš„å®é™…ä»“åº“
          run-id: ${{ inputs.run_id }}
          path: ./temp-bin

      - name: Prepare directory structure
        run: |
          mkdir -p ./bin/releases/${{ inputs.version }}
          mv ./temp-bin/* ./bin/releases/${{ inputs.version }}/ || true
          rm -rf ./temp-bin
          echo "å½“å‰ bin ç›®å½•ç»“æ„ï¼š"
          tree ./bin || ls -R ./bin

      - name: Generate recursive index.html
        run: |
          #!/usr/bin/env bash
          set -e
          cd ./bin
          find . -type d | while read dir; do
            cd "$dir"
            title_name=$(basename "$PWD")
            echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>'"$title_name"'</title></head><body><h1>Index of /'"$dir"'</h1><hr><pre><a href="../index.html">../</a>' > index.html
            for f in *; do
              [ "$f" = "index.html" ] && continue
              if [ -d "$f" ]; then
                # ç›®å½•ï¼šåç§°ååŠ â€œ/â€ï¼Œå›ºå®šå®½åº¦50å­—ç¬¦ï¼Œæœ«å°¾æ˜¾ç¤ºâ€œ-â€
                printf '<a href="%s/index.html">%-50s</a>  -\n' "$f" "$f/"
              else
                # æ–‡ä»¶ï¼šè·å–ä¿®æ”¹æ—¶é—´å’Œå¤§å°
                mod_time=$(stat -c '%Y-%m-%d %H:%M' "$f")
                size=$(stat -c '%s' "$f")
                # æ–‡ä»¶åè¿‡é•¿æ—¶æˆªæ–­å¹¶åŠ â€œ>â€
                if [ ${#f} -gt 50 ]; then
                  f_display=${f:0:49}'>'
                else
                  f_display=$f
                fi
                # è¾“å‡ºï¼šæ–‡ä»¶åï¼ˆå®½åº¦50ï¼‰ï¼Œæ—¶é—´ï¼Œå¤§å°å³å¯¹é½10ä½
                printf '<a href="%s">%-50s</a> %s %10d\n' "$f" "$f_display" "$mod_time" "$size"
              fi
            done
              echo '</pre><hr></body></html>' >> index.html
              cd - >/dev/null
          done
 

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./bin

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Notify Deploy Status
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ğŸš€ OpenWrt å‘å¸ƒå®Œæˆï¼
            çŠ¶æ€: ${{ job.status }}
            ä»“åº“: ${{ github.repository }}
            ç‰ˆæœ¬: ${{ inputs.version }}
            Pages åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/releases/${{ inputs.version }}/
